<!DOCTYPE html>
<html lang="en">
<head>
  <title>Birthday Tracker</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">
    const handleResponse = (xhr, parseResponse) =>{
        const content = document.querySelector('#content');

        switch(xhr.status){
            default: content.innerHTML = "<b>Not implemented</b>"; break;
            case 200: content.innerHTML = "<b>Success</b>"; break;
            case 201: content.innerHTML = "<b>Created</b>"; break;
            case 204: content.innerHTML = "<b>Updated (No Content)</b>"; break;
            case 400: content.innerHTML = "<b>Bad Request</b>"; break;
            case 404: content.innerHTML = "<b>Not Found</b>"; break;
        }

        if(parseResponse){
          const jsonObj = JSON.parse(xhr.response);
          console.dir(jsonObj);
          let message; 
          content.innerHTML += `<p>${message}</p>`;
        }else{
          content.innerHTML += `<p>Metadata received </p>`;
        }
    };

    const requestUpdate = (e, userForm) => {
      const url = userForm.querySelector('#urlField').value;
      const method = userForm.querySelector('#methodSelect').value;

      const xhr = new XMLHttpRequest();
      xhr.open(method, url);

      xhr.setRequestHeader('Accept', 'application/json');

      if(method === 'get'){
        xhr.onload = () => handleResponse(xhr, true);
      }else{
        xhr.onload = () => handleResponse(xhr, false);
      }

      xhr.send();

      e.preventDefault(); //Don't fire default event
      return false; //Prevent bubbling
    };

    const sendPost = (e, nameForm) => {
      e.preventDefault(); //Don't fire default event

      const nameAction = nameForm.getAttribute('action');
      const nameMethod = nameForm.getAttribute('method');
     
      const nameField = nameForm.querySelector('#nameField');
      const ageField = nameForm.querySelector('#ageField');

      const xhr = new XMLHttpRequest();
      xhr.open(nameMethod, nameAction);

      xhr.setRequestHeader('Accept', 'application/json');
      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

      xhr.onload = () => handleResponse(xhr, true);

      const formData = `name=${nameField.value}&age=${ageField.value}`
      xhr.send(formData);

      return false;
    }

    const init = () =>{
      //setup userForm submit action
      const userForm = document.querySelector('#userForm');
      const getUsers = (e) => requestUpdate(e, userForm);
      userForm.addEventListener('submit', getUsers);
      //setup nameForm submit action
      const nameForm = document.querySelector('#nameForm');
      const addUser = (e) => sendPost(e, nameForm);
      nameForm.addEventListener('submit', addUser);
    }

    window.onload = init;
  </script>
</head>
<body>
  <section id="top">

    <h1>Birthday Tracker</h1>

    <div id = "loginSection">
      <h3> Search for existing account </h3>
      <form id="getUserForm" action="/getUser?findUser=" method="get">
        <label for="getUsername"> Username </label>
        <input id="getUsername" type="text" name="name" placeholder="Enter Username"/>
        <input type="submit" value="Search" />
      </form>

      <h3> Or Create a new one</h3>
      <form id="createUserForm" action="/addUser" method="post">
        <label for="createUsername"> Username </label>
        <input id="createUsername" type="text" name="name" placeholder="Enter Username"/>
        <input type="submit" value="Create" />
      </form>
    </div>

    <div id = "birthdaysSection">
      <h2 id = "username"> Username </h2>
      <hr>
      <h3>New Birthday</h3>
      <form id="birthdayForm" action="/addBirthday" method="post">
        <label for="birthdayName"> Username </label>
        <input id="birthdayName" type="text" name="name" placeholder="Enter Name"/>
        <br>
        <label for="birthday">Birthday</label>
        <input type="date" id="birthday" name="birthday"> 
        <br>
        <input type="submit" value="Add" />
        <!--TODO: email and message input-->
      </form>
      <ul id = "birthdayList">

      </ul>
    </div>
  </section>
  <section id="content">
  </section>
</body>
</html>